<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rhythm Game</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(
          135deg,
          #ff6b9d 0%,
          #c44569 25%,
          #f8b500 50%,
          #40e0d0 75%,
          #ee5a52 100%
        );
        color: white;
        overflow: hidden;
        height: 100vh;
        width: 100vw;
      }

      .game-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
      }

      /* 상단 UI - 체력바 */
      .health-container {
        position: absolute;
        top: 20px;
        left: 20px;
        background: linear-gradient(90deg, #333 0%, #666 100%);
        border: 3px solid #888;
        border-radius: 15px;
        padding: 8px;
        z-index: 200;
      }

      .health-label {
        color: #ff4444;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 5px;
      }

      .health-bar {
        width: 200px;
        height: 20px;
        background: #000;
        border-radius: 10px;
        border: 2px solid #fff;
        position: relative;
        overflow: hidden;
      }

      .health-fill {
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          #00ff00 0%,
          #ffff00 50%,
          #ff0000 100%
        );
        transition: width 0.3s ease;
        border-radius: 8px;
      }

      /* 상단 UI - 점수 */
      .score-container {
        position: absolute;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #333 0%, #555 100%);
        border: 3px solid #4ecdc4;
        border-radius: 15px;
        padding: 15px 25px;
        text-align: right;
        z-index: 200;
      }

      .score-label {
        color: #4ecdc4;
        font-size: 14px;
        font-weight: bold;
      }

      .score-value {
        color: #4ecdc4;
        font-size: 28px;
        font-weight: bold;
        text-shadow: 0 0 10px rgba(78, 205, 196, 0.8);
      }

      /* 노래 정보 */
      .song-info {
        position: absolute;
        top: 120px;
        right: 20px;
        background: linear-gradient(135deg, #333 0%, #555 100%);
        border: 2px solid #ffd93d;
        border-radius: 10px;
        padding: 8px 15px;
        z-index: 200;
      }

      .song-title {
        color: #ffd93d;
        font-size: 16px;
        font-weight: bold;
      }

      /* 콤보 */
      .combo-container {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        background: linear-gradient(135deg, #333 0%, #555 100%);
        border: 3px solid #a55eea;
        border-radius: 15px;
        padding: 15px;
        text-align: center;
        z-index: 200;
      }

      .combo-label {
        color: #a55eea;
        font-size: 14px;
        font-weight: bold;
      }

      .combo-value {
        color: #a55eea;
        font-size: 36px;
        font-weight: bold;
        text-shadow: 0 0 15px rgba(165, 94, 234, 0.8);
      }

      /* 메인 게임 영역 - 화면 전체를 터널로 */
      .tunnel-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        perspective: 800px;
        perspective-origin: center 20%;
        transform-style: preserve-3d;
        z-index: 1;
      }

      /* 터널 바닥 - 화면 전체를 덮도록 */
      .tunnel-floor {
        position: absolute;
        top: -100vh;
        left: 50%;
        transform: translateX(-50%) rotateX(45deg);
        width: 100vw;
        height: 400vh;
        background: #000;
        transform-style: preserve-3d;
        z-index: 2;
      }

      /* 4개 레인 - 자연스러운 원근법 */
      .lane {
        position: absolute;
        top: 0;
        height: 100%;
        transform-style: preserve-3d;
        border-left: 4px solid;
        border-right: 4px solid;
        /* 위쪽이 약간 좁아지는 자연스러운 원근법 */
        clip-path: polygon(15% 0%, 85% 0%, 90% 100%, 10% 100%);
      }

      .lane-0 {
        left: 0;
        width: 25%;
        background: linear-gradient(
          to bottom,
          rgba(255, 107, 181, 0.2) 0%,
          rgba(255, 107, 181, 0.4) 30%,
          rgba(255, 107, 181, 0.6) 70%,
          rgba(255, 107, 181, 0.9) 100%
        );
        border-color: #ff6bb5;
        box-shadow: inset 0 0 50px rgba(255, 107, 181, 0.3),
          0 0 20px rgba(255, 107, 181, 0.4);
      }

      .lane-1 {
        left: 25%;
        width: 25%;
        background: linear-gradient(
          to bottom,
          rgba(64, 224, 208, 0.2) 0%,
          rgba(64, 224, 208, 0.4) 30%,
          rgba(64, 224, 208, 0.6) 70%,
          rgba(64, 224, 208, 0.9) 100%
        );
        border-color: #40e0d0;
        box-shadow: inset 0 0 50px rgba(64, 224, 208, 0.3),
          0 0 20px rgba(64, 224, 208, 0.4);
      }

      .lane-2 {
        left: 50%;
        width: 25%;
        background: linear-gradient(
          to bottom,
          rgba(64, 224, 208, 0.2) 0%,
          rgba(64, 224, 208, 0.4) 30%,
          rgba(64, 224, 208, 0.6) 70%,
          rgba(64, 224, 208, 0.9) 100%
        );
        border-color: #40e0d0;
        box-shadow: inset 0 0 50px rgba(64, 224, 208, 0.3),
          0 0 20px rgba(64, 224, 208, 0.4);
      }

      .lane-3 {
        left: 75%;
        width: 25%;
        background: linear-gradient(
          to bottom,
          rgba(248, 181, 0, 0.2) 0%,
          rgba(248, 181, 0, 0.4) 30%,
          rgba(248, 181, 0, 0.6) 70%,
          rgba(248, 181, 0, 0.9) 100%
        );
        border-color: #f8b500;
        box-shadow: inset 0 0 50px rgba(248, 181, 0, 0.3),
          0 0 20px rgba(248, 181, 0, 0.4);
      }

      /* 하단 타겟 바 컨테이너 - 3D 변형에 맞춰 배치 */
      .target-container {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 200px;
        z-index: 150;
        pointer-events: none;
      }

      /* 공통 타겟 바 스타일 */
      .hit-target {
        position: absolute;
        bottom: 60px;
        width: 15%;
        height: 60px;
        border-radius: 20px;
        border: 3px solid;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.4) 0%,
          rgba(255, 255, 255, 0.2) 50%,
          rgba(255, 255, 255, 0.3) 100%
        );
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.6),
          inset 0 2px 8px rgba(255, 255, 255, 0.3),
          inset 0 -2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
        transform-origin: center bottom;
      }

      /* 각 레인별 위치와 3D 변형 적용 - 레인 중앙에 정확히 배치 */
      .hit-target-0 {
        left: 15.0%;
        transform: perspective(600px) rotateY(8deg) rotateX(-45deg) translateX(-50%);
        border-color: #ff6bb5;
        background: linear-gradient(
          135deg,
          rgba(255, 107, 181, 0.6) 0%,
          rgba(255, 107, 181, 0.3) 50%,
          rgba(255, 107, 181, 0.5) 100%
        );
        box-shadow: 0 0 30px rgba(255, 107, 181, 0.8),
          inset 0 2px 8px rgba(255, 255, 255, 0.4);
      }

      .hit-target-1 {
        left: 38.5%;
        transform: perspective(600px) rotateY(3deg) rotateX(-45deg) translateX(-50%);
        border-color: #40e0d0;
        background: linear-gradient(
          135deg,
          rgba(64, 224, 208, 0.6) 0%,
          rgba(64, 224, 208, 0.3) 50%,
          rgba(64, 224, 208, 0.5) 100%
        );
        box-shadow: 0 0 30px rgba(64, 224, 208, 0.8),
          inset 0 2px 8px rgba(255, 255, 255, 0.4);
      }

      .hit-target-2 {
        left: 61.5%;
        transform: perspective(600px) rotateY(-3deg) rotateX(-45deg) translateX(-50%);
        border-color: #40e0d0;
        background: linear-gradient(
          135deg,
          rgba(64, 224, 208, 0.6) 0%,
          rgba(64, 224, 208, 0.3) 50%,
          rgba(64, 224, 208, 0.5) 100%
        );
        box-shadow: 0 0 30px rgba(64, 224, 208, 0.8),
          inset 0 2px 8px rgba(255, 255, 255, 0.4);
      }

      .hit-target-3 {
        left: 85.0%;
        transform: perspective(600px) rotateY(-8deg) rotateX(-45deg) translateX(-50%);
        border-color: #f8b500;
        background: linear-gradient(
          135deg,
          rgba(248, 181, 0, 0.6) 0%,
          rgba(248, 181, 0, 0.3) 50%,
          rgba(248, 181, 0, 0.5) 100%
        );
        box-shadow: 0 0 30px rgba(248, 181, 0, 0.8),
          inset 0 2px 8px rgba(255, 255, 255, 0.4);
      }

      /* 키 입력 시 활성화 효과 - 3D 변형 유지 */
      .hit-target-0.active {
        transform: perspective(600px) rotateY(8deg) rotateX(-45deg) translateX(-50%) scale(1.15);
        filter: brightness(1.3) saturate(1.2);
        box-shadow: 0 0 40px #ff6bb5, 0 0 60px rgba(255, 107, 181, 0.6),
          inset 0 0 20px rgba(255, 255, 255, 0.7);
      }

      .hit-target-1.active {
        transform: perspective(600px) rotateY(3deg) rotateX(-45deg) translateX(-50%) scale(1.15);
        filter: brightness(1.3) saturate(1.2);
        box-shadow: 0 0 40px #40e0d0, 0 0 60px rgba(64, 224, 208, 0.6),
          inset 0 0 20px rgba(255, 255, 255, 0.7);
      }

      .hit-target-2.active {
        transform: perspective(600px) rotateY(-3deg) rotateX(-45deg) translateX(-50%) scale(1.15);
        filter: brightness(1.3) saturate(1.2);
        box-shadow: 0 0 40px #40e0d0, 0 0 60px rgba(64, 224, 208, 0.6),
          inset 0 0 20px rgba(255, 255, 255, 0.7);
      }

      .hit-target-3.active {
        transform: perspective(600px) rotateY(-8deg) rotateX(-45deg) translateX(-50%) scale(1.15);
        filter: brightness(1.3) saturate(1.2);
        box-shadow: 0 0 40px #f8b500, 0 0 60px rgba(248, 181, 0, 0.6),
          inset 0 0 20px rgba(255, 255, 255, 0.7);
      }

      /* 노트 - 양옆으로 길쭉하게 */
      .note {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        height: 40px;
        border-radius: 20px;
        border: 2px solid rgba(255, 255, 255, 0.9);
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.9),
          rgba(200, 200, 200, 0.7)
        );
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
        z-index: 40;
      }

      /* 노트 애니메이션 */
      @keyframes notefall {
        0% {
          top: -10%;
          transform: translateX(-50%) scale(0.3);
          opacity: 0.5;
        }
        100% {
          top: 100%;
          transform: translateX(-50%) scale(1);
          opacity: 1;
        }
      }

      .note {
        animation: notefall 3s linear;
      }

      /* 컨트롤 버튼 */
      .controls {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 15px;
        z-index: 300;
      }

      button {
        padding: 12px 25px;
        font-size: 16px;
        font-weight: bold;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      }

      /* 숨김 요소 */
      .status {
        display: none;
      }

      #gameAudio {
        display: none;
      }

      /* 파장 효과 애니메이션 - 약하게 */
      @keyframes rippleEffect {
        0% {
          width: 15px;
          height: 15px;
          opacity: 1;
        }
        100% {
          width: 100px;
          height: 100px;
          opacity: 0;
        }
      }

      /* 판정 텍스트 애니메이션 */
      .judgment {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 48px;
        font-weight: bold;
        text-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        z-index: 1000;
        animation: judgmentPop 1s ease-out forwards;
        pointer-events: none;
      }

      .judgment.perfect {
        color: #ff6bb5;
        text-shadow: 0 0 20px #ff6bb5;
      }

      .judgment.great {
        color: #40e0d0;
        text-shadow: 0 0 20px #40e0d0;
      }

      .judgment.good {
        color: #ffd93d;
        text-shadow: 0 0 20px #ffd93d;
      }

      .judgment.bad {
        color: #ff4444;
        text-shadow: 0 0 20px #ff4444;
      }

      @keyframes judgmentPop {
        0% {
          transform: translate(-50%, -50%) scale(0.5);
          opacity: 0;
        }
        20% {
          transform: translate(-50%, -50%) scale(1.2);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0;
        }
      }

      /* 게임 오버 모달 */
      .game-over-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .game-over-content {
        background: linear-gradient(135deg, #333 0%, #555 100%);
        border: 3px solid #ff4444;
        border-radius: 20px;
        padding: 40px;
        text-align: center;
        box-shadow: 0 0 30px rgba(255, 68, 68, 0.5);
      }

      .game-over-title {
        font-size: 48px;
        font-weight: bold;
        color: #ff4444;
        margin-bottom: 20px;
        text-shadow: 0 0 20px #ff4444;
      }

      .game-over-score {
        font-size: 24px;
        color: white;
        margin-bottom: 30px;
      }

      .game-over-button {
        padding: 15px 30px;
        font-size: 18px;
        font-weight: bold;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        background: linear-gradient(45deg, #ff4444, #cc3333);
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
      }

      .game-over-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 68, 68, 0.4);
      }

      /* 콤보 보너스 효과 */
      .combo-bonus {
        position: fixed;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        font-weight: bold;
        color: #ffd93d;
        text-shadow: 0 0 15px #ffd93d;
        z-index: 1500;
        animation: comboBonusPop 1.5s ease-out forwards;
        pointer-events: none;
      }

      .bonus-label {
        font-size: 14px;
        color: #fff;
        text-shadow: 0 0 10px #ffd93d;
        display: block;
        margin-top: 5px;
      }

      @keyframes comboBonusPop {
        0% {
          transform: translate(-50%, -50%) scale(0.5);
          opacity: 0;
        }
        20% {
          transform: translate(-50%, -50%) scale(1.2);
          opacity: 1;
        }
        80% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -50%) scale(0.8);
          opacity: 0;
        }
      }

      /* 콤보 단계별 효과 */
      .combo-yellow {
        border-color: #ffd93d !important;
        box-shadow: 0 0 20px rgba(255, 217, 61, 0.8) !important;
        animation: comboGlow 0.5s ease-in-out;
      }

      .combo-orange {
        border-color: #ff9500 !important;
        box-shadow: 0 0 25px rgba(255, 149, 0, 0.9) !important;
        animation: comboGlow 0.5s ease-in-out;
      }

      .combo-red {
        border-color: #ff4757 !important;
        box-shadow: 0 0 30px rgba(255, 71, 87, 1.0) !important;
        animation: comboGlow 0.5s ease-in-out;
      }

      .combo-rainbow {
        border: 3px solid;
        border-image: linear-gradient(45deg, #ff6b9d, #4ecdc4, #ffd93d, #ff6b9d) 1;
        box-shadow: 0 0 35px rgba(255, 255, 255, 1.0) !important;
        animation: rainbowPulse 1s ease-in-out infinite;
      }

      @keyframes comboGlow {
        0% { transform: translateY(-50%) scale(1); }
        50% { transform: translateY(-50%) scale(1.1); }
        100% { transform: translateY(-50%) scale(1); }
      }

      @keyframes rainbowPulse {
        0%, 100% {
          transform: translateY(-50%) scale(1);
          filter: hue-rotate(0deg) brightness(1);
        }
        50% {
          transform: translateY(-50%) scale(1.15);
          filter: hue-rotate(180deg) brightness(1.3);
        }
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <!-- 상단 UI -->
      <div class="health-container">
        <div class="health-label">HP</div>
        <div class="health-bar">
          <div class="health-fill" id="health-fill"></div>
        </div>
      </div>

      <div class="score-container">
        <div class="score-label">SCORE</div>
        <div class="score-value" id="score">0</div>
      </div>

      <div class="song-info">
        <div class="song-title" id="song-title">변수화해야됨</div>
      </div>

      <div class="combo-container">
        <div class="combo-label">COMBO</div>
        <div class="combo-value" id="combo">0</div>
      </div>

      <!-- 3D 터널 게임 영역 -->
      <div class="tunnel-container">
        <div class="tunnel-floor">
          <div class="lane lane-0"></div>
          <div class="lane lane-1"></div>
          <div class="lane lane-2"></div>
          <div class="lane lane-3"></div>
        </div>
      </div>

      <!-- 하단 타겟 영역 -->
      <div class="target-container">
        <div class="hit-target hit-target-0"></div>
        <div class="hit-target hit-target-1"></div>
        <div class="hit-target hit-target-2"></div>
        <div class="hit-target hit-target-3"></div>
      </div>

      <!-- 컨트롤 버튼들 -->
      <div class="controls">
        <button onclick="loadBeatmap()">Load Beatmap</button>
        <button onclick="startGame()">Start Game</button>
        <button onclick="resetGame()">Reset</button>
      </div>

      <!-- 숨겨진 요소들 -->
      <audio id="gameAudio">
        <source src="backend/audio_mp3/5NarVgDFNX0.mp3" type="audio/mpeg" />
      </audio>

      <div class="status">
        <div>Status: <span id="status">Ready</span></div>
        <div>Beatmap: <span id="beatmap-info">Not loaded</span></div>
      </div>
    </div>

    <!-- 게임 오버 모달 -->
    <div class="game-over-modal" id="game-over-modal">
      <div class="game-over-content">
        <div class="game-over-title">GAME OVER</div>
        <div class="game-over-score">
          Final Score: <span id="final-score">0</span>
        </div>
        <button class="game-over-button" onclick="restartGame()">Restart Game</button>
      </div>
    </div>

    <script>
      let beatmap = null;
      let gameStarted = false;
      let notes = [];
      let score = 0;
      let combo = 0;
      let startTime = 0;
      let health = 100;
      let activeNotes = new Map(); // 활성화된 노트들을 추적

      async function loadBeatmap() {
        try {
          document.getElementById("status").textContent = "Loading...";
          const response = await fetch(
            "http://localhost:8001/5ba220a0-5cfb-412e-a84c-6dc3a0b41d0e.json"
          );

          if (!response.ok) {
            throw new Error("Failed to load beatmap");
          }

          beatmap = await response.json();
          document.getElementById("beatmap-info").textContent = `${
            beatmap.events.length
          } events, BPM: ${beatmap.tempo.toFixed(1)}`;
          document.getElementById("status").textContent = "Beatmap loaded!";

          console.log("Loaded beatmap:", beatmap);
        } catch (error) {
          console.error("Error loading beatmap:", error);
          document.getElementById("status").textContent =
            "Error loading beatmap";
          document.getElementById("beatmap-info").textContent = error.message;
        }
      }

      function startGame() {
        if (!beatmap) {
          alert("Please load a beatmap first!");
          return;
        }

        if (gameStarted) {
          alert("Game already started!");
          return;
        }

        gameStarted = true;
        startTime = Date.now();
        console.log(`[DEBUG] 게임 시작 시간: ${new Date(startTime).toLocaleTimeString()}.${startTime % 1000}`);
        score = 0;
        combo = 0;
        document.getElementById("score").textContent = "0";
        document.getElementById("combo").textContent = "0";
        document.getElementById("status").textContent = "Playing...";

        // 음악 재생
        const audio = document.getElementById("gameAudio");
        audio.currentTime = 0;
        audio.play().catch((e) => console.log("Audio play failed:", e));

        // 모든 노트 생성
        beatmap.events.forEach((event, index) => {
          setTimeout(() => {
            createNote(event.lane, event.type, event.time);
          }, event.time * 1000);
        });

        console.log(`Game started! ${beatmap.events.length} notes scheduled.`);
      }

      function createNote(lane, type, eventTime) {
        const laneElement = document.querySelector(`.lane-${lane}`);
        const note = document.createElement("div");
        note.className = "note";
        note.dataset.lane = lane;
        note.dataset.type = type;

        // 고유 ID 생성
        const noteId = `note_${Date.now()}_${Math.random()}`;
        note.dataset.id = noteId;

        // 노트 색상 설정
        const colors = {
          0: type === "strong" ? "#ff4757" : "#ff6bb5",
          1: type === "strong" ? "#2ed573" : "#40e0d0",
          2: type === "strong" ? "#1e90ff" : "#40e0d0",
          3: type === "strong" ? "#ffa502" : "#f8b500",
        };

        note.style.background = `linear-gradient(145deg, ${colors[lane]}, rgba(255,255,255,0.3))`;
        note.style.border = `2px solid ${colors[lane]}`;
        note.style.boxShadow = `0 0 20px ${colors[lane]}80`;

        laneElement.appendChild(note);
        
        // activeNotes에 추가 (게임 시작 시간 기준으로 정확한 히트 타이밍 계산)
        // 노트 애니메이션이 3초이고, 타겟바 도달 시점 조정 (2.8초로 늦춤)
        const hitTime = startTime + (eventTime * 1000) + 2800;
        activeNotes.set(noteId, {
          element: note,
          lane: lane,
          hitTime: hitTime,
          missed: false
        });
        
        console.log(`[DEBUG] 노트 생성: Lane ${lane}, EventTime: ${eventTime}s, HitTime: ${new Date(hitTime).toLocaleTimeString()}.${hitTime % 1000}`);

        // 3초 후 노트 제거 (놓친 노트 처리)
        setTimeout(() => {
          if (note.parentNode && activeNotes.has(noteId)) {
            // 놓친 노트 - BAD 처리
            const noteData = activeNotes.get(noteId);
            if (!noteData.missed) {
              showJudgment('BAD');
              updateHealth(-5); // 체력 5% 감소
              combo = 0;
              updateUI();
            }
            activeNotes.delete(noteId);
            note.parentNode.removeChild(note);
          }
        }, 3000);
      }

      function resetGame() {
        gameStarted = false;
        score = 0;
        combo = 0;
        health = 100;
        activeNotes.clear();
        document.getElementById("score").textContent = "0";
        document.getElementById("combo").textContent = "0";
        document.getElementById("status").textContent = "Ready";
        document.getElementById("health-fill").style.width = "100%";
        document.getElementById("game-over-modal").style.display = "none";

        // 음악 중지
        const audio = document.getElementById("gameAudio");
        audio.pause();
        audio.currentTime = 0;

        // 모든 노트 제거
        document.querySelectorAll(".note").forEach((note) => {
          if (note.parentNode) {
            note.parentNode.removeChild(note);
          }
        });

        // 판정 텍스트 제거
        document.querySelectorAll(".judgment").forEach((judgment) => {
          if (judgment.parentNode) {
            judgment.parentNode.removeChild(judgment);
          }
        });
      }

      function restartGame() {
        resetGame();
        if (beatmap) {
          startGame();
        }
      }

      function updateHealth(change) {
        health = Math.max(0, Math.min(100, health + change));
        document.getElementById("health-fill").style.width = `${health}%`;
        
        if (health <= 0) {
          gameOver();
        }
      }

      function gameOver() {
        gameStarted = false;
        document.getElementById("final-score").textContent = score.toLocaleString();
        document.getElementById("game-over-modal").style.display = "flex";
        
        // 음악 중지
        const audio = document.getElementById("gameAudio");
        audio.pause();
      }

      function showJudgment(type) {
        const judgment = document.createElement("div");
        judgment.className = `judgment ${type.toLowerCase()}`;
        judgment.textContent = type.toUpperCase();
        document.body.appendChild(judgment);
        
        setTimeout(() => {
          if (judgment.parentNode) {
            judgment.parentNode.removeChild(judgment);
          }
        }, 1000);
      }

      function calculateJudgment(timeDiff) {
        const absTimeDiff = Math.abs(timeDiff);
        
        console.log(`[DEBUG] 판정 계산: rawTimeDiff=${timeDiff}ms, absTimeDiff=${absTimeDiff}ms`);
        
        // 정상적인 리듬게임 판정 (타겟바 두 배 길이 개념)
        if (absTimeDiff <= 100) return 'PERFECT';  // 100ms 이내 PERFECT
        else if (absTimeDiff <= 200) return 'GREAT';   // 200ms 이내 GREAT  
        else if (absTimeDiff <= 300) return 'GOOD';    // 300ms 이내 GOOD
        else return 'BAD';
      }

      function getScoreForJudgment(judgment) {
        switch (judgment) {
          case 'PERFECT': return 100;
          case 'GREAT': return 80;
          case 'GOOD': return 60;
          case 'BAD': return 0;
          default: return 0;
        }
      }

      function getComboBonus(combo) {
        if (combo >= 100) return 100;
        else if (combo >= 50) return 60;
        else if (combo >= 30) return 40;
        else if (combo >= 10) return 20;
        else return 0;
      }

      function showComboBonus(baseScore, bonus, totalScore) {
        if (bonus > 0) {
          const bonusElement = document.createElement("div");
          bonusElement.className = "combo-bonus";
          bonusElement.innerHTML = `+${bonus} <span class="bonus-label">COMBO BONUS!</span>`;
          document.body.appendChild(bonusElement);
          
          setTimeout(() => {
            if (bonusElement.parentNode) {
              bonusElement.parentNode.removeChild(bonusElement);
            }
          }, 1500);
        }
      }

      function updateComboEffects() {
        const comboContainer = document.querySelector('.combo-container');
        const comboValue = document.getElementById('combo');
        
        // 기존 효과 제거
        comboContainer.className = 'combo-container';
        
        if (combo >= 100) {
          comboContainer.classList.add('combo-rainbow');
        } else if (combo >= 50) {
          comboContainer.classList.add('combo-red');
        } else if (combo >= 30) {
          comboContainer.classList.add('combo-orange');
        } else if (combo >= 10) {
          comboContainer.classList.add('combo-yellow');
        }
      }

      function updateUI() {
        document.getElementById("score").textContent = score.toLocaleString();
        document.getElementById("combo").textContent = combo;
      }

      function handleNoteHit(lane) {
        const currentTime = Date.now();
        let bestNote = null;
        let bestTimeDiff = Infinity;

        // 해당 레인의 가장 가까운 노트 찾기
        let laneNotes = [];
        for (let [noteId, noteData] of activeNotes) {
          if (noteData.lane === lane && !noteData.missed) {
            const timeDiff = Math.abs(currentTime - noteData.hitTime);
            laneNotes.push({ id: noteId, timeDiff, hitTime: noteData.hitTime, rawTimeDiff: currentTime - noteData.hitTime });
            
            if (timeDiff < bestTimeDiff && timeDiff <= 400) { // 400ms 이내만 유효 (적당히 후한 설정)
              bestTimeDiff = timeDiff;
              bestNote = { id: noteId, data: noteData, timeDiff: currentTime - noteData.hitTime };
            }
          }
        }
        
        console.log(`[DEBUG] Lane ${lane} 노트들:`, laneNotes.map(n => ({ 
          timeDiff: n.timeDiff + 'ms', 
          rawDiff: n.rawTimeDiff + 'ms',
          hitTime: new Date(n.hitTime).toLocaleTimeString() + '.' + (n.hitTime % 1000)
        })));
        console.log(`[DEBUG] 선택된 노트:`, bestNote ? { timeDiff: bestNote.timeDiff + 'ms' } : 'None');

        if (bestNote) {
          const judgment = calculateJudgment(bestNote.timeDiff);
          const baseScore = getScoreForJudgment(judgment);
          
          if (judgment !== 'BAD') {
            combo += 1;
            const comboBonus = getComboBonus(combo);
            const totalScore = baseScore + comboBonus;
            score += totalScore;
            
            showComboBonus(baseScore, comboBonus, totalScore);
            updateComboEffects();
          } else {
            combo = 0;
            score += baseScore;
            updateHealth(-5); // BAD일 때 체력 감소
            updateComboEffects();
          }
          
          showJudgment(judgment);
          updateUI();

          // 노트 제거
          console.log(`[DEBUG] 노트 제거 시도: ${bestNote.id}, 판정: ${judgment}`);
          bestNote.data.missed = true;
          if (bestNote.data.element.parentNode) {
            bestNote.data.element.parentNode.removeChild(bestNote.data.element);
            console.log(`[DEBUG] 노트 DOM에서 제거됨: ${bestNote.id}`);
          }
          activeNotes.delete(bestNote.id);
          console.log(`[DEBUG] activeNotes에서 제거됨. 남은 노트: ${activeNotes.size}`);

          return true;
        }
        
        return false;
      }

      // 키보드 입력 처리
      document.addEventListener("keydown", (event) => {
        console.log(`[DEBUG] 키 감지: ${event.key}, gameStarted: ${gameStarted}`);
        
        let lane = -1;
        switch (event.key.toLowerCase()) {
          case "a":
            lane = 0;
            break;
          case "s":
            lane = 1;
            break;
          case "k":
            lane = 2;
            break;
          case "l":
            lane = 3;
            break;
          default:
            console.log(`[DEBUG] 무시된 키: ${event.key}`);
            return;
        }
        
        console.log(`[DEBUG] 매핑된 레인: ${lane}`);

        // 타겟 바 활성화 효과
        const hitTarget = document.querySelector(`.hit-target-${lane}`);
        const laneElement = document.querySelector(`.lane-${lane}`);

        hitTarget.classList.add("active");

        // 레인 전체에도 효과 추가 - 약하게
        laneElement.style.filter = "brightness(1.2) saturate(1.1)";
        laneElement.style.transform = "scale(1.02)";


        setTimeout(() => {
          hitTarget.classList.remove("active");
          laneElement.style.filter = "";
          laneElement.style.transform = "";
        }, 200);

        // 게임이 시작된 경우 노트 판정 처리
        if (gameStarted) {
          console.log(`[DEBUG] 키 입력: Lane ${lane}, CurrentTime: ${new Date().toLocaleTimeString()}.${Date.now() % 1000}, ActiveNotes: ${activeNotes.size}`);
          const hitResult = handleNoteHit(lane);
          console.log(`[DEBUG] handleNoteHit 결과: ${hitResult}`);
        } else {
          console.log(`[DEBUG] 게임이 시작되지 않았음: gameStarted = ${gameStarted}`);
        }
      });

      // 페이지 로드 시 상태 확인
      window.onload = function () {
        console.log("Game loaded! Backend should be at http://localhost:8001");
      };
    </script>
  </body>
</html>
